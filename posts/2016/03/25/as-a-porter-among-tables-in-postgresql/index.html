<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>As a Porter Among Tables in Postgresql - YenTing Chen</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="As a Porter Among Tables in Postgresql" />
<meta property="og:description" content="Imagine we have two tables, creations and creation_metadata. id of creations table is foreign key of creation_metadata table. They should be one-to-one relation but actually, records in creations table might not have a corresponding row in creation_metadata table.
We want to fix this problem and also move some data from creations table to creation_metadata table.
Before continuing, let’s make the target clear. What we want is
 Avoid inserting with existing creation_id in target table." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/2016/03/25/as-a-porter-among-tables-in-postgresql/" />
<meta property="article:published_time" content="2016-03-25T16:00:00&#43;08:00"/>
<meta property="article:modified_time" content="2016-03-25T16:00:00&#43;08:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="As a Porter Among Tables in Postgresql"/>
<meta name="twitter:description" content="Imagine we have two tables, creations and creation_metadata. id of creations table is foreign key of creation_metadata table. They should be one-to-one relation but actually, records in creations table might not have a corresponding row in creation_metadata table.
We want to fix this problem and also move some data from creations table to creation_metadata table.
Before continuing, let’s make the target clear. What we want is
 Avoid inserting with existing creation_id in target table."/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:500,100,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" /><script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script><script src="/js/main.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<h1 class="site-title">YenTing Chen</h1>
	<div class="site-description"><h2>a.k.a JimYTC</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/jimytc" title="Github"><i data-feather="github"></i></a><a href="https://twitter.com/jimytc" title="Twitter"><i data-feather="twitter"></i></a><a href="https://www.facebook.com/jim.yenting" title="Facebook"><i data-feather="facebook"></i></a><a href="https://www.linkedin.com/in/yentingchen/" title="LinkedIn"><i data-feather="linkedin"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">As a Porter Among Tables in Postgresql</h1>
			<div class="meta">Posted at &mdash; Mar 25, 2016</div>
		</div>

		<div class="markdown">
			

<p>Imagine we have two tables, <strong>creations</strong> and <strong>creation_metadata</strong>. <strong>id</strong> of <strong>creations</strong> table is foreign key of <strong>creation_metadata</strong> table. They should be one-to-one relation but actually, records in <strong>creations</strong> table might not have a corresponding row in <strong>creation_metadata</strong> table.</p>

<p>We want to fix this problem and also move some data from <strong>creations</strong> table to <strong>creation_metadata</strong> table.</p>

<p>Before continuing, let’s make the target clear. What we want is</p>

<ol>
<li>Avoid inserting with existing <strong>creation_id</strong> in target table.</li>
<li>Update value for those existing ones.</li>
</ol>

<hr />

<h3 id="upsert-https-wiki-postgresql-org-wiki-upsert-command-lands-on-postgresql"><a href="https://wiki.postgresql.org/wiki/UPSERT">UPSERT</a> command lands on PostgreSQL!</h3>

<p>What a wonderful thing when we need to deal with the problem above. Command looks like below.</p>

<p><img src="https://giphy.com/gifs/celebrate-DKnMqdm9i980E?utm_source=iframe&amp;utm_medium=embed&amp;utm_campaign=Embeds&amp;utm_term=https%3A%2F%2Fcdn.embedly.com%2Fwidgets%2Fmedia.html%3Fsrc%3Dhttps%3A%2F%2Fgiphy.com%2Fembed%2FDKnMqdm9i980E%2Ftwitter%2Fiframe&amp;%3Bsrc_secure=1&amp;%3Burl=http%3A%2F%2Fgiphy.com%2Fgifs%2Fcelebrate-DKnMqdm9i980E&amp;%3Bimage=https%3A%2F%2Fmedia.giphy.com%2Fmedia%2FDKnMqdm9i980E%2Fgiphy.gif&amp;%3Bkey=d04bfffea46d4aeda930ec88cc64b87c&amp;%3Btype=text%2Fhtml&amp;%3Bschema=giphy" alt="Hooray" /></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00f">INSERT</span> <span style="color:#00f">INTO</span> creation_metadata (creation_id, category)
     <span style="color:#00f">SELECT</span> id, <span style="color:#00f">type</span>
       <span style="color:#00f">FROM</span> creations
  <span style="color:#00f">ON</span> CONFLICT <span style="color:#00f">DO</span> <span style="color:#00f">UPDATE</span> <span style="color:#00f">SET</span> category = EXCLUDED.<span style="color:#00f">type</span>;</code></pre></div>
<p>You can check the syntax <a href="http://www.postgresql.org/docs/9.5/static/sql-insert.html">here</a>.</p>

<p>As you see, <a href="https://wiki.postgresql.org/wiki/UPSERT">UPSERT</a> in PostgreSQL is an extended clause for <a href="http://www.postgresql.org/docs/9.5/static/sql-insert.html">INSERT</a>. Since “<strong>creation_id</strong>“ is <strong>unique</strong> in target table, insertion would fail for existing records and fall into <strong>ON CONFLICT</strong> clause. In the sample above, we do update for conflictions.</p>

<hr />

<h2 id="unfortunately">Unfortunately&hellip;</h2>

<p>I’m afraid you cannot use <a href="https://wiki.postgresql.org/wiki/UPSERT">UPSERT</a> if your PostgreSQL is 9.4 or earlier. Good news is that there are approaches.</p>

<h2 id="let-s-list-the-steps">Let’s list the steps.</h2>

<ol>
<li>Get those rows needs move.</li>
<li>Update for existing ones.</li>
<li>Lastly, insert new rows.</li>
</ol>

<hr />

<h3 id="use-with-query-common-table-expression">Use WITH query (Common Table Expression)</h3>

<p><strong>WITH</strong> query can help to get result that can be referenced in the main query. So we can still have a command to make the goal.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00f">WITH</span> creations_need_move <span style="color:#00f">AS</span> (
  <span style="color:#00f">SELECT</span> id, <span style="color:#00f">type</span>
    <span style="color:#00f">FROM</span> creations
   <span style="color:#00f">WHERE</span> <span style="color:#00f">type</span> <span style="color:#00f">IS</span> <span style="color:#00f">NOT</span> <span style="color:#00f">NULL</span>
),
update_existing_metadata <span style="color:#00f">AS</span> (
  <span style="color:#00f">UPDATE</span> creation_metadata (creation_id, category)
     <span style="color:#00f">SET</span> category = <span style="color:#00f">source</span>.<span style="color:#00f">type</span>
    <span style="color:#00f">FROM</span> creations_need_move <span style="color:#00f">source</span>
   <span style="color:#00f">WHERE</span> creation_id = <span style="color:#00f">source</span>.id
   RETURNING creation_metadata.*
)
<span style="color:#00f">INSERT</span> <span style="color:#00f">INTO</span> creation_metadata (creation_id, category)
     <span style="color:#00f">SELECT</span> id, <span style="color:#00f">type</span>
       <span style="color:#00f">FROM</span> creations_need_move
      <span style="color:#00f">WHERE</span> <span style="color:#00f">NOT</span> <span style="color:#00f">EXISTING</span> ( <span style="color:#00f">SELECT</span> 1
                             <span style="color:#00f">FROM</span> update_existing_metadata up
                            <span style="color:#00f">WHERE</span> up.creation_id = creations_need_move.id )</code></pre></div>
<h3 id="use-pl-pgsql">Use PL/PGSQL</h3>

<p>Another way is to define new function in PostgreSQL which gives a more straightforward point of view when reading the code.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00f">CREATE</span> <span style="color:#00f">OR</span> <span style="color:#00f">REPLACE</span> <span style="color:#00f">FUNCTION</span> upsert(target_id INT, type_value TEXT) <span style="color:#00f">RETURNS</span> VOID <span style="color:#00f">AS</span> <span style="">$$</span>
  <span style="color:#00f">BEGIN</span>
    <span style="color:#008000">-- Try update first
</span><span style="color:#008000"></span>    <span style="color:#00f">UPDATE</span> creation_metadata <span style="color:#00f">SET</span> category = type_value
     <span style="color:#00f">WHERE</span> creation_id = target_id;
    <span style="color:#008000">-- Return if UPDATE command runs successfully
</span><span style="color:#008000"></span>    <span style="color:#00f">IF</span> <span style="color:#00f">FOUND</span> <span style="color:#00f">THEN</span>
      <span style="color:#00f">RETURN</span>;
    <span style="color:#00f">END</span> <span style="color:#00f">IF</span>;
    <span style="color:#008000">-- Since there&#39;s no record in creation_metada
</span><span style="color:#008000"></span>    <span style="color:#008000">-- We then add new row with INSERT command
</span><span style="color:#008000"></span>    <span style="color:#00f">INSERT</span> <span style="color:#00f">INTO</span> creation_metadata (creation_id, category)
         <span style="color:#00f">VALUES</span> (target_id, type_value);
  <span style="color:#00f">END</span>;co
<span style="">$$</span> <span style="color:#00f">LANGUAGE</span> <span style="color:#a31515">&#39;plpgsql&#39;</span>;

<span style="color:#00f">SELECT</span> upsert(id, <span style="color:#00f">type</span>)
  <span style="color:#00f">FROM</span> creations
 <span style="color:#00f">WHERE</span> <span style="color:#00f">type</span> <span style="color:#00f">IS</span> <span style="color:#00f">NOT</span> <span style="color:#00f">NULL</span></code></pre></div>
<hr />

<p>Relational database performs better when queries are straightforward. We also care about atomic operation and race condition during the process. Two approaches above do loops and this may make the performance worse. Further, they might overwrite the rows comes with new application code.</p>

<h3 id="insert-with-left-join">INSERT with LEFT JOIN</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00f">INSERT</span> <span style="color:#00f">INTO</span> creation_metadata (creation_id, category)
     <span style="color:#00f">SELECT</span> creations.id, creations.<span style="color:#00f">type</span>
       <span style="color:#00f">FROM</span> creations
       <span style="color:#00f">LEFT</span> <span style="color:#00f">JOIN</span> creation_metadata
              <span style="color:#00f">ON</span> creations.id = creation_metadata.creation_id
      <span style="color:#00f">WHERE</span> creations.<span style="color:#00f">type</span> <span style="color:#00f">IS</span> <span style="color:#00f">NOT</span> <span style="color:#00f">NULL</span>
        <span style="color:#00f">AND</span> creation_metadata.category <span style="color:#00f">IS</span> <span style="color:#00f">NULL</span></code></pre></div>
<p>The idea here is we actually want the result to be one-to-one relation among two tables and <strong>LEFT JOIN</strong> helps us to get the full results for it. Moreover, we can know which record has no relation in another table. The best part is this is a single query and only take effect <strong>ONCE</strong>!</p>

		</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = 'jimytc-github-io';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
		Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div><a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="gohugo.io">Hugo</a></div>
	</nav>
</div>

</body>
</html>
