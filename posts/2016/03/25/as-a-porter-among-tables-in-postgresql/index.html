<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.55.6" />

    
    
    

<title>As a Porter Among Tables in Postgresql • YenTing Chen</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="As a Porter Among Tables in Postgresql"/>
<meta name="twitter:description" content="Imagine we have two tables, creations and creation_metadata. id of creations table is foreign key of creation_metadata table. They should be one-to-one relation but actually, records in creations table might not have a corresponding row in creation_metadata table."/>

<meta property="og:title" content="As a Porter Among Tables in Postgresql" />
<meta property="og:description" content="Imagine we have two tables, creations and creation_metadata. id of creations table is foreign key of creation_metadata table. They should be one-to-one relation but actually, records in creations table might not have a corresponding row in creation_metadata table." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.jimytc.com/posts/2016/03/25/as-a-porter-among-tables-in-postgresql/" />
<meta property="article:published_time" content="2016-03-25T16:00:00&#43;08:00"/>
<meta property="article:modified_time" content="2016-03-25T16:00:00&#43;08:00"/><meta property="og:site_name" content="Software Developer" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.6a83d62c39a364f036df4db1ecd564645635d6c7fc182425cb501218fec485f5.css" integrity="sha256-aoPWLDmjZPA2302x7NVkZFY11sf8GCQly1ASGP7EhfU=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
</head>


    <body class="theme-base-08 ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://www.jimytc.com/">YenTing Chen</a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://www.jimytc.com/images/author-photo.jpg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         a.k.a. JimYTC 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">YenTing Chen</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>Tags</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/categories/">
						<span>Categories</span>
					</a>
				</li>
			 
		
		</li>
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/jimytc" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://facebook.com/jim.yenting" rel="me"><i class="fab fa-facebook-f"></i></a>
	
	
	<a href="https://github.com/jimytc" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	<a href="https://instagram.com/jimytc" rel="me"><i class="fab fa-instagram fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://linkedin.com/in/yentingchen" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://stackoverflow.com/users/2728942/jimytc" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2019 jimytc
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>As a Porter Among Tables in Postgresql</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Mar 25, 2016
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/engineering">ENGINEERING</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/postgresql">postgresql</a>
           
      
          <a class="badge badge-tag" href="/tags/database">database</a>
           
      
          <a class="badge badge-tag" href="/tags/sql">sql</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 3 min read
</div>


  </header>
  
  
  <div class="post">
    

<p>Imagine we have two tables, <strong>creations</strong> and <strong>creation_metadata</strong>. <strong>id</strong> of <strong>creations</strong> table is foreign key of <strong>creation_metadata</strong> table. They should be one-to-one relation but actually, records in <strong>creations</strong> table might not have a corresponding row in <strong>creation_metadata</strong> table.</p>

<p>We want to fix this problem and also move some data from <strong>creations</strong> table to <strong>creation_metadata</strong> table.</p>

<p>Before continuing, let’s make the target clear. What we want is</p>

<ol>
<li>Avoid inserting with existing <strong>creation_id</strong> in target table.</li>
<li>Update value for those existing ones.</li>
</ol>

<hr />

<h3 id="upsert-https-wiki-postgresql-org-wiki-upsert-command-lands-on-postgresql"><a href="https://wiki.postgresql.org/wiki/UPSERT">UPSERT</a> command lands on PostgreSQL!</h3>

<p>What a wonderful thing when we need to deal with the problem above. Command looks like below.</p>

<p><img src="https://giphy.com/gifs/celebrate-DKnMqdm9i980E?utm_source=iframe&amp;utm_medium=embed&amp;utm_campaign=Embeds&amp;utm_term=https%3A%2F%2Fcdn.embedly.com%2Fwidgets%2Fmedia.html%3Fsrc%3Dhttps%3A%2F%2Fgiphy.com%2Fembed%2FDKnMqdm9i980E%2Ftwitter%2Fiframe&amp;%3Bsrc_secure=1&amp;%3Burl=http%3A%2F%2Fgiphy.com%2Fgifs%2Fcelebrate-DKnMqdm9i980E&amp;%3Bimage=https%3A%2F%2Fmedia.giphy.com%2Fmedia%2FDKnMqdm9i980E%2Fgiphy.gif&amp;%3Bkey=d04bfffea46d4aeda930ec88cc64b87c&amp;%3Btype=text%2Fhtml&amp;%3Bschema=giphy" alt="Hooray" /></p>

<pre><code class="language-sql">INSERT INTO creation_metadata (creation_id, category)
     SELECT id, type
       FROM creations
  ON CONFLICT DO UPDATE SET category = EXCLUDED.type;
</code></pre>

<p>You can check the syntax <a href="http://www.postgresql.org/docs/9.5/static/sql-insert.html">here</a>.</p>

<p>As you see, <a href="https://wiki.postgresql.org/wiki/UPSERT">UPSERT</a> in PostgreSQL is an extended clause for <a href="http://www.postgresql.org/docs/9.5/static/sql-insert.html">INSERT</a>. Since “<strong>creation_id</strong>“ is <strong>unique</strong> in target table, insertion would fail for existing records and fall into <strong>ON CONFLICT</strong> clause. In the sample above, we do update for conflictions.</p>

<hr />

<h2 id="unfortunately">Unfortunately&hellip;</h2>

<p>I’m afraid you cannot use <a href="https://wiki.postgresql.org/wiki/UPSERT">UPSERT</a> if your PostgreSQL is 9.4 or earlier. Good news is that there are approaches.</p>

<h3 id="let-s-list-the-steps">Let’s list the steps.</h3>

<ol>
<li>Get those rows needs move.</li>
<li>Update for existing ones.</li>
<li>Lastly, insert new rows.</li>
</ol>

<hr />

<h3 id="use-with-query-common-table-expression">Use WITH query (Common Table Expression)</h3>

<p><strong>WITH</strong> query can help to get result that can be referenced in the main query. So we can still have a command to make the goal.</p>

<pre><code class="language-sql">WITH creations_need_move AS (
  SELECT id, type
    FROM creations
   WHERE type IS NOT NULL
),
update_existing_metadata AS (
  UPDATE creation_metadata (creation_id, category)
     SET category = source.type
    FROM creations_need_move source
   WHERE creation_id = source.id
   RETURNING creation_metadata.*
)
INSERT INTO creation_metadata (creation_id, category)
     SELECT id, type
       FROM creations_need_move
      WHERE NOT EXISTING ( SELECT 1
                             FROM update_existing_metadata up
                            WHERE up.creation_id = creations_need_move.id )
</code></pre>

<h3 id="use-pl-pgsql">Use PL/PGSQL</h3>

<p>Another way is to define new function in PostgreSQL which gives a more straightforward point of view when reading the code.</p>

<pre><code class="language-sql">CREATE OR REPLACE FUNCTION upsert(target_id INT, type_value TEXT) RETURNS VOID AS $$
  BEGIN
    -- Try update first
    UPDATE creation_metadata SET category = type_value
     WHERE creation_id = target_id;
    -- Return if UPDATE command runs successfully
    IF FOUND THEN
      RETURN;
    END IF;
    -- Since there's no record in creation_metada
    -- We then add new row with INSERT command
    INSERT INTO creation_metadata (creation_id, category)
         VALUES (target_id, type_value);
  END;co
$$ LANGUAGE 'plpgsql';

SELECT upsert(id, type)
  FROM creations
 WHERE type IS NOT NULL
</code></pre>

<hr />

<p>Relational database performs better when queries are straightforward. We also care about atomic operation and race condition during the process. Two approaches above do loops and this may make the performance worse. Further, they might overwrite the rows comes with new application code.</p>

<h3 id="insert-with-left-join">INSERT with LEFT JOIN</h3>

<pre><code class="language-sql">INSERT INTO creation_metadata (creation_id, category)
     SELECT creations.id, creations.type
       FROM creations
       LEFT JOIN creation_metadata
              ON creations.id = creation_metadata.creation_id
      WHERE creations.type IS NOT NULL
        AND creation_metadata.category IS NULL
</code></pre>

<p>The idea here is we actually want the result to be one-to-one relation among two tables and <strong>LEFT JOIN</strong> helps us to get the full results for it. Moreover, we can know which record has no relation in another table. The best part is this is a single query and only take effect <strong>ONCE</strong>!</p>

  </div>
  


  

  
    
        <div id="disqus_thread"></div>
<script type="text/javascript">
    

    (function () {
    if (location.hostname === "localhost" ||
      location.hostname === "127.0.0.1" ||
      location.hostname === "") {
      return;
    }
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    var disqus_shortname = 'jimytc-github-io';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || 
      document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<noscript>
  Please enable JavaScript to view the
  <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by
  <span class="logo-disqus">Disqus</span>
</a>

    


</article>


        </div>
        
    

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-9646591-7', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.5.0/js/all.js" integrity="sha384-GqVMZRt5Gn7tB9D9q7ONtcp4gtHIUEW/yG7h98J7IpE3kpi+srfFyyB/04OV6pG0" crossorigin="anonymous"></script>


    
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
    
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    




    



    </body>
</html>
